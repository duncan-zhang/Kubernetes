# Install kubeadm

## Install All Nodes

```sh
sudo ./intall-k8s.sh
```

### k8s-master

1. 拉取集群 images(可選)

```sh
sudo kubeadm config images pull
```

2. 初始化 Kubeadm

```sh
sudo kubeadm init --apiserver-advertise-address=<k8s-master_ip>  --pod-network-cidr=172.16.0.0/16
```

3.Worker 節點添加方式

```sh
 Then you can join any number of worker nodes by running the following on each as root:

kubeadm join <k8s-master_IP>:6443 --token <token> \
  --discovery-token-ca-cert-hash sha256:<sha256_token>
```

4.配置.kube

```sh
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

5.檢查狀態

```sh
kubectl get nodes
kubectl get pods -A
```

6.指令補全

把自動補全 + k 別名寫入 ~/.bashrc：

```sh
sudo apt install bash-completion -y
echo "source <(kubectl completion bash)" >> ~/.bashrc
echo "alias k=kubectl" >> ~/.bashrc
echo "complete -F __start_kubectl k" >> ~/.bashrc
```

重新載入:

```
source ~/.bashrc
```

7.新增 kube-flannel

下載`kube-flannel.yml`

```sh
curl -LO https://github.com/flannel-io/flannel/releases/download/v0.25.5/kube-flannel.yml
```

編輯`kube-flannel.yml`的配置與`pod-network-cidr`一致:

```json
net-conf.json: |
  {
    "Network": "172.16.0.0/16",
    "Backend": {
      "Type": "vxlan"
    }
  }
```

執行`flannel.yaml`

```sh
kubectl apply -f flannel.yaml
```

### k8s-worker

worker 節點運行 join 即可

```sh
kubeadm join <k8s-master_IP>:6443 --token <token> \
  --discovery-token-ca-cert-hash sha256:<sha256_token>
```
